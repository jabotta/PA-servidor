<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ElegirCategoriaComponente.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;ProgramacionApp&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">Vista</a> &gt; <span class="el_source">ElegirCategoriaComponente.java</span></div><h1>ElegirCategoriaComponente.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package Vista;

import Controlador.Clases.Categoria;
import Controlador.Clases.Constantes;
import Controlador.Clases.IControladorProductos;
import Controlador.Clases.ManejadorCategorias;
import Controlador.DataTypes.DataCategoria;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Objects;
import javax.swing.JButton;
import javax.swing.JPanel;
import javax.swing.JTree;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.TreePath;
import javax.swing.tree.TreeSelectionModel;

/**
 *
 * @author rodro
 */
class ElegirCategoriaComponente extends JPanel {

    private final DefaultMutableTreeNode node;
    private ArrayList categoriasAgregadas;
<span class="nc" id="L35">    private static Comparator&lt;NodoCategoria&gt; comp = new Comparator&lt;NodoCategoria&gt;() {</span>

        @Override
        public int compare(NodoCategoria o1, NodoCategoria o2) {

<span class="nc" id="L40">            return o1.nombre.compareTo(o2.nombre);</span>

        }
    };
    private final ArrayList&lt;String&gt; selectedCategorias;
    private final IControladorProductos cotrolador;
    private final JTree tree;

<span class="nc" id="L48">    public ElegirCategoriaComponente(IControladorProductos controlador, Boolean ultimaCategoria) {</span>
<span class="nc" id="L49">        this.cotrolador = controlador;</span>
<span class="nc" id="L50">        selectedCategorias = new ArrayList();</span>
<span class="nc" id="L51">        node = new DefaultMutableTreeNode(Constantes.CATEGORIA_ROOT);</span>
<span class="nc" id="L52">         tree = new JTree(node);</span>
<span class="nc" id="L53">        tree.getSelectionModel().setSelectionMode(TreeSelectionModel.DISCONTIGUOUS_TREE_SELECTION);</span>
        TreeSelectionListener myTreeListener;
<span class="nc" id="L55">        myTreeListener = new TreeSelectionListener() {</span>

            @Override
            public void valueChanged(TreeSelectionEvent e) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">                for (int i = 0; i &lt; e.getPaths().length; i++) {</span>
//                    System.out.println(e.getPaths()[i]);
<span class="nc bnc" id="L61" title="All 2 branches missed.">                    if (e.isAddedPath(e.getPaths()[i])) {</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">                        if (ultimaCategoria) {</span>

<span class="nc" id="L65">                            selectedCategorias.add(e.getPath().getLastPathComponent().toString().trim());</span>
                        } else {
<span class="nc bnc" id="L67" title="All 2 branches missed.">                            for (int j = 0; j &lt; e.getPaths()[i].getPathCount(); j++) {</span>
                                //if(!selectedCategorias.contains((e.getPaths()[i]).getPathComponent(j).toString()))
<span class="nc" id="L69">                                selectedCategorias.add((e.getPaths()[i]).getPathComponent(j).toString().trim());</span>
                            }
                        }
                    } else {
<span class="nc bnc" id="L73" title="All 2 branches missed.">                        for (int j = 0; j &lt; e.getPaths()[i].getPathCount(); j++) {</span>
<span class="nc" id="L74">                            selectedCategorias.remove((e.getPaths()[i]).getPathComponent(j).toString().trim());</span>
                        }
                    }
                }
                // System.out.println(&quot;--&quot;+getSelectedCategories());
<span class="nc" id="L79">            }</span>

        };
<span class="nc" id="L82">        tree.addTreeSelectionListener(myTreeListener);</span>

<span class="nc" id="L84">        buildTree();</span>
<span class="nc" id="L85">        add(tree);</span>
<span class="nc" id="L86">        setSize(400, 400);</span>
<span class="nc" id="L87">    }</span>

    public HashSet&lt;String&gt; getSelectedCategories() {
<span class="nc" id="L90">        HashSet&lt;String&gt; r = new HashSet();</span>
<span class="nc" id="L91">        r.addAll(selectedCategorias);</span>
<span class="nc" id="L92">        r.remove(Constantes.CATEGORIA_ROOT);</span>
<span class="nc" id="L93">        return r;</span>
    }

    /**
     *
     * @TODO: Este algoritmo es una caca
     *
     *
     */
    private void buildTree() {

<span class="nc" id="L104">        categoriasAgregadas = new ArrayList();</span>

<span class="nc" id="L106">        cotrolador.listarCategorias().forEach((categoria) -&gt; {</span>

            DataCategoria auxDeBusqueda = categoria;
            NodoCategoria auxHuerfana = null;
            Boolean padresAgregados = false;

            while (!padresAgregados) {

                if (!auxDeBusqueda.tienePadre()) {

                    NodoCategoria nodoRaiz = new NodoCategoria(auxDeBusqueda.getNombre());
                    if (auxHuerfana != null) {
                        nodoRaiz.addHijo(auxHuerfana);
                    }

                    if (!categoriasAgregadas.contains(nodoRaiz)) {

                        categoriasAgregadas.add(nodoRaiz);

                    }
                    auxHuerfana = null;
                    padresAgregados = true;

                } else {
                    NodoCategoria encontrado = getPadre(auxDeBusqueda.getPadre().getNombre());

                    if (encontrado != null) {
                        padresAgregados = true;
                        NodoCategoria newNodo = new NodoCategoria(auxDeBusqueda.getNombre());
                        if (encontrado.find(auxDeBusqueda.getNombre()) == null) {
                            encontrado.addHijo(newNodo);
                        }

                    } else {

                        NodoCategoria padre = new NodoCategoria(auxDeBusqueda.getPadre().getNombre());
                        padre.addHijo(new NodoCategoria(auxDeBusqueda.getNombre()));
                        if (auxDeBusqueda.getPadre().tienePadre()) {
                            auxDeBusqueda = auxDeBusqueda.getPadre().getPadre();
                            auxHuerfana = padre;
                        } else {
                            categoriasAgregadas.add(padre);
                            padresAgregados = true;
                        }
                    }
                }
            }

        });

<span class="nc" id="L156">        categoriasAgregadas.sort(ElegirCategoriaComponente.comp);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (Iterator&lt;NodoCategoria&gt; it = categoriasAgregadas.iterator(); it.hasNext();) {</span>
<span class="nc" id="L158">            NodoCategoria current = it.next();</span>
<span class="nc" id="L159">            node.add(current.getSubTree());</span>
<span class="nc" id="L160">        }</span>
   
<span class="nc" id="L162">    }</span>
   
    public NodoCategoria getPadre(String padre) {
<span class="nc" id="L165">        Boolean found = false;</span>
<span class="nc" id="L166">        NodoCategoria encontrado = null;</span>
<span class="nc bnc" id="L167" title="All 4 branches missed.">        for (Iterator&lt;NodoCategoria&gt; it = categoriasAgregadas.iterator(); it.hasNext() &amp;&amp; !found;) {</span>
<span class="nc" id="L168">            NodoCategoria current = it.next();</span>

<span class="nc" id="L170">            encontrado = current.find(padre);</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">            found = encontrado != null;</span>
<span class="nc" id="L173">        }</span>
<span class="nc" id="L174">        return encontrado;</span>
    }

    public class NodoCategoria {

        public ArrayList&lt;NodoCategoria&gt; hijos;
        public String nombre;

<span class="nc" id="L182">        public NodoCategoria(String nombre) {</span>
<span class="nc" id="L183">            this.hijos = new ArrayList();</span>
<span class="nc" id="L184">            this.nombre = nombre;</span>

<span class="nc" id="L186">        }</span>

        @Override
        public int hashCode() {
<span class="nc" id="L190">            int hash = 3;</span>
<span class="nc" id="L191">            hash = 71 * hash + Objects.hashCode(this.nombre);</span>
<span class="nc" id="L192">            return hash;</span>
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (obj == null) {</span>
<span class="nc" id="L198">                return false;</span>
            }
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L201">                return false;</span>
            }
<span class="nc" id="L203">            final NodoCategoria other = (NodoCategoria) obj;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (!Objects.equals(this.nombre, other.nombre)) {</span>
<span class="nc" id="L205">                return false;</span>
            }
<span class="nc" id="L207">            return true;</span>
        }

        public void addHijo(NodoCategoria h) {

<span class="nc" id="L212">            this.hijos.add(h);</span>
<span class="nc" id="L213">            hijos.sort(ElegirCategoriaComponente.comp);</span>
<span class="nc" id="L214">        }</span>

        public NodoCategoria find(String nombre) {
<span class="nc" id="L217">            NodoCategoria encontrado = null;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (this.nombre.equals(nombre)) {</span>
<span class="nc" id="L219">                return this;</span>

            } else {
<span class="nc bnc" id="L222" title="All 4 branches missed.">                for (Iterator&lt;NodoCategoria&gt; it = hijos.iterator(); it.hasNext() &amp;&amp; encontrado == null;) {</span>
<span class="nc" id="L223">                    NodoCategoria current = it.next();</span>
<span class="nc" id="L224">                    encontrado = current.find(nombre);</span>
<span class="nc" id="L225">                }</span>
            }
<span class="nc" id="L227">            return encontrado;</span>
        }

        public DefaultMutableTreeNode getSubTree() {
<span class="nc" id="L231">            DefaultMutableTreeNode firstNode = new DefaultMutableTreeNode(this.nombre);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            for (Iterator&lt;NodoCategoria&gt; it = hijos.iterator(); it.hasNext();) {</span>
<span class="nc" id="L233">                NodoCategoria current = it.next();</span>
<span class="nc" id="L234">                firstNode.add(current.getSubTree());</span>
<span class="nc" id="L235">            }</span>
<span class="nc" id="L236">            return firstNode;</span>
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>